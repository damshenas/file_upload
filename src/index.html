<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body{font-family:Arial}.tab{overflow:hidden;border:1% solid #ccc;background-color:#f1f1f1;display: none;}.tab button{background-color:inherit;float:left;border:none;outline:0;cursor:pointer;padding:2% 3%;transition:.3s;font-size:17px}.tab button:hover{background-color:#ddd}.tab button.active{background-color:#ccc}.tabcontent{display:none;padding:1% 2%;-webkit-animation:fadeEffect 1s;animation:fadeEffect 1s}@-webkit-keyframes fadeEffect{from{opacity:0}to{opacity:1}}@keyframes fadeEffect{from{opacity:0}to{opacity:1}}
    input[type=text],select{width:30%;padding:2% 4%;margin:2% 0;display:inline-block;border:1% solid #ccc;border-radius:1%;box-sizing:border-box}.submit[type=submit]{width:30%;background-color:#4caf50;color:#fff;padding:2% 4%;margin:2% 0;border:none;border-radius:1%;cursor:pointer}input[type=submit]:hover{background-color:#45a049}.div{border-radius:2%;background-color:#f2f2f2;padding:5%}
    table{border-collapse:collapse;table-layout: fixed;width:100%}td,th{text-align:left;padding:1%;word-wrap:break-word;}tr:nth-child(even){background-color:#f2f2f2}
  </style>
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
  <script>

    $(document).ready(function () {
      var preSignedUrl =  JSON.parse('###preSignedUrl###');
      $("#upload_image_form").attr('action', preSignedUrl.url);
      $('input[name="key"]').val(preSignedUrl.fields.key);
      $('input[name="X-Amz-Credential"]').val(preSignedUrl.fields['x-amz-credential']);
      $('input[name="X-Amz-Algorithm"]').val(preSignedUrl.fields['x-amz-algorithm']);
      $('input[name="X-Amz-Date"]').val(preSignedUrl.fields['x-amz-date']);
      $('input[name="x-amz-security-token"]').val(preSignedUrl.fields['x-amz-security-token']);
      $('input[name="Policy"]').val(preSignedUrl.fields.policy);
      $('input[name="X-Amz-Signature"]').val(preSignedUrl.fields['x-amz-signature']);
    });

    function openTab(evt, tabName) {
      $("#upload_result").text('');
      $("#upload_result").css("color", "black");
      $("#file_select").val('');

      var i, tabcontent, tablinks;
      tabcontent = document.getElementsByClassName("tabcontent");
      for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
      }
      tablinks = document.getElementsByClassName("tablinks");
      for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
      }
      document.getElementById(tabName).style.display = "block";
      evt.currentTarget.className += " active";
    }

    function submitFileUpload() {
      event.preventDefault();

      $("#upload_result").text('Uploading ...');
      $("#upload_result").css("color", "blue");

      $('#submit_upload').attr("onclick","event.preventDefault();");
      $('#submit_upload').css("background-color","gray");

      // $('input[name="key"]').val(Date.now() + '__' + $('input[type=file]').val().split('\\').pop());
      // $('#submit_upload').prop('disabled', true);
      // $(this).find(':input[type=submit]').attr('disabled', true);

      var formData = new FormData();
      var selectedFile = $('input[name="file"]')[0]

      $('#upload_image_form *').filter(':input').filter(":hidden").each(function(k, v){
        formData.append(v.name, v.defaultValue);
      });

      formData.append("file", selectedFile.files[0]);

      $.ajax({
          xhr: function() {
            var xhr = new window.XMLHttpRequest();

            xhr.upload.addEventListener("progress", function(evt) {
              if (evt.lengthComputable) {
                var percentComplete = evt.loaded / evt.total;
                percentComplete = parseInt(percentComplete * 100);
                $("#upload_result").text('Uploading ... ' + percentComplete + '%');

                if (percentComplete === 100) {
                  $("#upload_result").text('Upload is finalizing.');
                }

              }
            }, false);

            return xhr;
          },
          url: $("#upload_image_form").attr('action'),
          type: 'POST',
          data: formData,
          success: function (data) {
            $("#upload_result").text('The file has been successfully uploaded!');
            $("#upload_result").css("color", "green");
          },
          error: function(xhr, textStatus, errorThrown){
            $("#upload_result").text('The file upload failed! Please refresh the page to retry.');
            $("#upload_result").css("color", "red");
            console.log(textStatus);
            console.log(errorThrown);
          },
          cache: false,
          contentType: false,
          processData: false
      });

    };

  </script>

  <title>Upload a file</title>

</head>

<body>

  <div style="width: 50%; margin-left: 25%;">

    <div class="tab" style="margin-top: 10px;">
      <button class="tablinks" onclick="openTab(event, 'upload')" id="default_tab">Upload</button>
    </div>

    <div id="upload" class="tabcontent">
      <h3>Upload file</h3>
      <p>Select file to upload:</p>
      <form id="upload_image_form" method="post" enctype="multipart/form-data">
        <input type="hidden" name="key"/><br />
        <input type="hidden" name="X-Amz-Credential"/>
        <input type="hidden" name="X-Amz-Algorithm"/>
        <input type="hidden" name="X-Amz-Date"/>
        <input type="hidden" name="x-amz-security-token"/>
        <input type="hidden" name="Policy"/>
        <input type="hidden" name="X-Amz-Signature"/>
        <input type="file" id="file_select" name="file"/> <br />
        <input id="submit_upload" type="submit" class="submit" value="Upload" onclick="submitFileUpload()"/>
      </form>
      <p id="upload_result"></p>
    </div>

  </div>

  <script>
    document.getElementById("default_tab").click();
  </script>

</body>

</html>
